<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作品详情</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 添加鼠标样式 */
        * {
            cursor: default;
        }

        a, button, input {
            cursor: pointer;
        }

        .work-detail {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        .work-header {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }

        .work-preview {
            flex: 1;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .work-preview::after {
            content: '点击查看大图';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .work-preview:hover::after {
            opacity: 1;
        }

        .work-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .work-info {
            flex: 1;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .work-title {
            font-size: 2em;
            margin-bottom: 20px;
            color: #fff;
        }

        .work-description {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .work-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tag {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.8);
        }

        .work-links {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(45deg, #6c63ff, #4a42e0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .work-specs {
            margin-top: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .specs-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #fff;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .spec-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
        }

        .spec-name {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }

        .spec-value {
            font-size: 1.1em;
            color: #fff;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }

        .delete-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(244, 67, 54, 0.8);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .delete-btn:hover {
            background: rgba(244, 67, 54, 1);
            transform: translateY(-2px);
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .password-modal.show {
            display: flex;
        }

        .password-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            width: 300px;
        }

        .password-form h3 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }

        .password-input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .password-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        .password-submit {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(45deg, #6c63ff, #4a42e0);
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .password-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .error-message {
            color: #f44336;
            text-align: center;
            margin-top: 10px;
            display: none;
        }

        @media (max-width: 768px) {
            .work-header {
                flex-direction: column;
            }
        }

        /* 添加编辑按钮样式 */
        .edit-btn {
            position: fixed;
            top: 20px;
            right: 200px;
            background: rgba(76, 175, 80, 0.8);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        .edit-btn:hover {
            background: rgba(76, 175, 80, 1);
            transform: translateY(-2px);
        }

        /* 编辑模态框样式 */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .edit-modal.show {
            display: flex;
        }

        .edit-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-form h3 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* 添加文件上传区域样式 */
        .file-drop-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .file-drop-area:hover, .file-drop-area.active {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
        }

        .file-drop-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
        }

        .file-drop-text i {
            font-size: 2em;
            margin-bottom: 10px;
            display: block;
            color: rgba(255, 255, 255, 0.5);
        }

        .preview-container {
            margin-top: 10px;
            display: none;
        }

        .preview-container img {
            max-width: 100%;
            border-radius: 10px;
        }

        .spec-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .spec-item .form-control {
            flex: 1;
        }

        .remove-spec {
            background: rgba(244, 67, 54, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .remove-spec:hover {
            background: rgba(244, 67, 54, 1);
            transform: scale(1.1);
        }

        .add-spec {
            background: rgba(76, 175, 80, 0.8);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .add-spec:hover {
            background: rgba(76, 175, 80, 1);
            transform: translateY(-2px);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-cancel, .btn-save {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-save {
            background: linear-gradient(45deg, #6c63ff, #4a42e0);
            color: white;
        }

        .btn-cancel:hover, .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* 添加图片查看模态框样式 */
        .image-view-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .image-view-modal.show {
            display: flex;
        }

        .image-view-container {
            position: relative;
            max-width: 90%;
            max-height: 90vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-view-container img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 10px;
        }

        .close-image-view {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .close-image-view:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        /* Token配置界面样式 */
        .token-config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .token-config-form {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            width: 400px;
        }

        .token-config-form h3 {
            color: white;
            margin-bottom: 20px;
            text-align: center;
        }

        .token-hint {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 15px;
            font-size: 14px;
            text-align: center;
        }

        .token-input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .token-input:focus {
            outline: none;
            border-color: #6c63ff;
            background: rgba(255, 255, 255, 0.15);
        }

        .token-submit {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(45deg, #6c63ff, #4a42e0);
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .token-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .token-error {
            color: #ff4d4d;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #6c63ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 优化GitHub图片选择器样式 */
        .github-select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 15px;
            cursor: pointer;
            font-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 15px top 50%;
            background-size: 12px auto;
            padding-right: 30px;
        }

        .github-select:focus {
            outline: none;
            border-color: #6c63ff;
            background-color: rgba(255, 255, 255, 0.15);
        }

        .github-preview {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .github-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .github-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .github-checkbox input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .github-checkbox label {
            color: white;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- 添加返回首页按钮 -->
    <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-left"></i> 返回首页
    </a>

    <button class="delete-btn" id="deleteBtn">
        <i class="fas fa-trash"></i>
        删除作品
    </button>

    <button class="edit-btn" id="editBtn">
        <i class="fas fa-edit"></i>
        编辑作品
    </button>

    <div class="work-detail">
        <div class="work-header">
            <div class="work-preview" id="workPreviewContainer">
                <img id="workPreview" src="" alt="作品预览">
            </div>
            <div class="work-info">
                <h1 class="work-title" id="workTitle"></h1>
                <p class="work-description" id="workDescription"></p>
                <div class="work-tags" id="workTags"></div>
                <div class="work-links">
                    <a href="#" id="videoLink" class="btn btn-primary" target="_blank">
                        <i class="fas fa-play"></i> 观看视频
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="edit-modal" id="editModal">
        <div class="edit-form">
            <h3>编辑作品</h3>
            <div class="form-group">
                <label for="editTitle">作品标题</label>
                <input type="text" id="editTitle" class="form-control">
            </div>
            <div class="form-group">
                <label for="editDescription">作品描述</label>
                <textarea id="editDescription" class="form-control" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="editVideoLink">视频链接</label>
                <input type="text" id="editVideoLink" class="form-control">
            </div>
            <div class="form-group" id="editPreviewImageArea">
                <label for="editPreviewImage">上传预览图</label>
                <div class="file-drop-area">
                    <input type="file" id="editPreviewImage" accept="image/*" style="display: none;">
                    <div class="file-drop-text">
                        <i class="fas fa-upload"></i>
                        点击或拖拽图片到此处上传
                    </div>
                </div>
                <div id="editPreviewContainer" class="preview-container"></div>
            </div>
            <div class="form-group">
                <label>标签</label>
                <div class="tags-container" id="editTagsContainer">
                    <!-- 标签将通过JavaScript动态添加 -->
                </div>
                <div class="tag-input-container">
                    <input type="text" id="editTagInput" class="form-control" placeholder="输入标签后按回车添加">
                    <button type="button" class="add-tag-btn" id="editAddTagBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            <div class="form-group" id="githubImageSelectGroup" style="display: none;">
                <label>从GitHub选择图片</label>
                <div class="github-input">
                    <select class="form-control github-select" id="githubSelect">
                        <option value="">选择GitHub图片</option>
                    </select>
                    <div class="github-preview" id="githubPreviewEdit" style="display:none; margin-top: 15px;"></div>
                </div>
            </div>
            <div class="form-group">
                <div class="github-checkbox">
                    <input type="checkbox" id="useGithubEdit">
                    <label for="useGithubEdit">使用GitHub图片</label>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn-cancel" id="editCancel">取消</button>
                <button type="button" class="btn-save" id="editSave">保存</button>
            </div>
        </div>
    </div>

    <!-- 添加图片查看模态框 -->
    <div class="image-view-modal" id="imageViewModal">
        <div class="image-view-container">
            <img id="largeImage" src="" alt="作品大图">
            <button class="close-image-view" id="closeImageView">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- GitHub Token配置模态框 -->
    <div class="token-config-modal" id="tokenConfigModal" style="display: none;">
        <div class="token-config-form">
            <h3>配置 GitHub Token</h3>
            <div class="token-instructions">
                <p class="token-hint">请输入与上传页面相同的GitHub Token</p>
                <p class="token-hint">Token用于从GitHub仓库获取作品数据</p>
            </div>
            <input type="password" class="token-input" id="tokenInput" placeholder="请输入GitHub Token">
            <button class="token-submit" id="tokenSubmit">确认</button>
            <p class="token-error" id="tokenError" style="display: none;">Token无效，请重试</p>
        </div>
    </div>

    <script>
        // GitHub配置
        const GITHUB_CONFIG = {
            owner: 'SiYangHuaTan',
            repo: 'SiYangHuaTan.github.io',
            branch: 'main',
            token: '', // 初始为空，将从localStorage加载
            worksFile: 'data/works.json'
        };

        // 全局变量存储当前作品和所有作品列表
        let currentWork = null;
        let allWorks = [];

        // 从GitHub获取作品数据
        async function fetchWorksFromGitHub() {
            try {
                // 尝试从localStorage加载token
                const savedToken = localStorage.getItem('github_token');
                if (savedToken) {
                    console.log('从localStorage加载GitHub Token');
                    GITHUB_CONFIG.token = savedToken;
                }

                // 构建请求头 - 公开仓库可以不带token访问
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // 只有存在Token时才添加
                if (GITHUB_CONFIG.token) {
                    headers['Authorization'] = `token ${GITHUB_CONFIG.token}`;
                }
                
                // 添加随机参数避免缓存问题
                const cacheBuster = Date.now();
                const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.worksFile}?_=${cacheBuster}`;
                
                console.log('正在请求GitHub API:', url);
                
                const response = await fetch(url, {
                    headers: headers,
                    cache: 'no-store' // 添加此选项避免缓存
                });

                if (response.status === 404) {
                    console.log('没有找到作品数据文件');
                    return [];
                }

                if (!response.ok) {
                    // 特殊处理403错误，可能是API速率限制
                    if (response.status === 403) {
                        const resetTime = response.headers.get('X-RateLimit-Reset');
                        const limitRemaining = response.headers.get('X-RateLimit-Remaining');
                        
                        console.log('GitHub API限制信息:', {
                            remaining: limitRemaining,
                            resetTime: resetTime ? new Date(resetTime * 1000).toLocaleString() : 'unknown'
                        });
                        
                        // 对于公共仓库，即使没有token也应该能获取内容
                        // 除非超出GitHub的API限制
                        if (limitRemaining === '0') {
                            showMessage('警告', '已达到GitHub API访问限制，请稍后再试');
                            return [];
                        } else if (!GITHUB_CONFIG.token) {
                            // 如果没有token且遇到403，可能需要token才能编辑
                            showMessage('提示', '需要在上传页面配置GitHub Token才能编辑作品');
                        }
                    }
                    
                    // 其他错误
                    const errorText = await response.text();
                    console.error('API错误:', response.status, errorText);
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();
                
                try {
                    // 安全解码内容
                    const content = data.content.replace(/\s/g, ''); // 移除所有空白字符
                    
                    // 使用正确的方式解码Base64并处理UTF-8字符
                    const binaryString = atob(content);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    
                    // 使用TextDecoder将UTF-8字节转换回字符串
                    const decoder = new TextDecoder('utf-8');
                    const jsonString = decoder.decode(bytes);
                    
                    // 解析JSON字符串
                    const works = JSON.parse(jsonString);
                    
                    console.log('成功获取作品数据:', works.length);
                    return works;
                } catch (decodeError) {
                    console.error('解码数据失败:', decodeError);
                    showMessage('错误', '数据解码失败: ' + decodeError.message);
                    return [];
                }
            } catch (error) {
                console.error('获取作品数据失败:', error);
                showMessage('错误', '获取作品数据失败: ' + error.message);
                return [];
            }
        }

        // 保存作品数据到GitHub
        async function saveWorksToGitHub(works) {
            try {
                // 检查Token是否已配置
                if (!GITHUB_CONFIG.token) {
                    throw new Error('请先配置GitHub Token');
                }
                
                // 获取现有文件的SHA（如果存在）
                let sha = '';
                try {
                    const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.worksFile}`, {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    // 如果文件存在，获取SHA
                    if (response.ok) {
                        const data = await response.json();
                        sha = data.sha;
                        console.log('找到现有文件，SHA:', sha);
                    } else if (response.status === 404) {
                        console.log('文件不存在，将创建新文件');
                    } else {
                        throw new Error(`获取文件信息失败: ${response.status} ${response.statusText}`);
                    }
                } catch (error) {
                    console.log('获取文件信息时出错:', error.message);
                    // 404错误已经在上面处理，其他错误需要抛出
                    if (!error.message.includes('404')) {
                        throw error;
                    }
                }

                // 使用正确的编码方式处理中文
                // 先将对象转换为JSON字符串
                const jsonString = JSON.stringify(works, null, 2);
                console.log('JSON字符串预览:', jsonString.substring(0, 100) + '...');
                
                // 将字符串转换为UTF-8编码的Uint8Array
                const encoder = new TextEncoder();
                const utf8Bytes = encoder.encode(jsonString);
                
                // 转换为Base64
                const base64Content = btoa(
                    Array.from(utf8Bytes)
                        .map(byte => String.fromCharCode(byte))
                        .join('')
                );
                
                // 准备更新或创建文件
                const body = {
                    message: '更新作品数据',
                    content: base64Content,
                    branch: GITHUB_CONFIG.branch
                };

                if (sha) {
                    body.sha = sha;
                }
                
                console.log('准备保存数据，文件路径:', GITHUB_CONFIG.worksFile);

                // 发送请求创建/更新文件
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.worksFile}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(body)
                });

                const responseData = await response.json();
                
                if (!response.ok) {
                    console.error('API错误响应:', responseData);
                    if (responseData.message.includes('personal access token')) {
                        throw new Error('Token权限不足，请确保您的Token有仓库写入权限');
                    } else {
                        throw new Error(`保存失败: ${responseData.message}`);
                    }
                }

                console.log('作品数据保存成功');
                return true;
            } catch (error) {
                console.error('保存作品数据失败:', error);
                throw error;
            }
        }

        // 显示消息
        function showMessage(type, message) {
            alert(`${type}: ${message}`);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            const workId = urlParams.get('id');
            const autoEdit = urlParams.get('edit') === 'true';

            // 显示加载动画
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
            document.body.appendChild(loadingOverlay);

            try {
                // 从GitHub获取作品数据
                allWorks = await fetchWorksFromGitHub();
                
                // 根据ID查找作品
                currentWork = allWorks.find(w => w.id == workId);

                // 移除加载动画
                loadingOverlay.remove();

                if (currentWork) {
                    // 填充作品信息
                    document.getElementById('workPreview').src = currentWork.previewImage;
                    document.getElementById('workTitle').textContent = currentWork.title;
                    document.getElementById('workDescription').textContent = currentWork.description;
                    
                    // 设置页面标题
                    document.title = `${currentWork.title} - 作品详情`;
                    
                    // 填充标签
                    const tagsContainer = document.getElementById('workTags');
                    if (currentWork.tags && Array.isArray(currentWork.tags)) {
                        currentWork.tags.forEach(tag => {
                            const tagElement = document.createElement('span');
                            tagElement.className = 'tag';
                            tagElement.textContent = tag;
                            tagsContainer.appendChild(tagElement);
                        });
                    }

                    // 设置视频链接
                    const videoLink = document.getElementById('videoLink');
                    if (currentWork.videoLink) {
                        // 确保链接包含协议
                        let videoUrl = currentWork.videoLink;
                        if (!videoUrl.startsWith('http://') && !videoUrl.startsWith('https://')) {
                            videoUrl = 'https://' + videoUrl;
                        }
                        videoLink.href = videoUrl;
                    } else {
                        videoLink.style.display = 'none';
                    }

                    // 添加删除功能
                    setupDeleteFunction();
                    
                    // 添加编辑功能
                    setupEditFunction();

                    // 添加图片查看功能
                    setupImageViewer();

                    // 如果URL包含edit=true参数，自动打开编辑模态框
                    if (autoEdit && currentWork) {
                        console.log('自动打开编辑模态框');
                        setTimeout(function() {
                            // 填充编辑表单
                            populateEditForm();
                            editModal.classList.add('show');
                        }, 1000);
                    }
                } else {
                    // 如果找不到作品，显示错误信息
                    document.querySelector('.work-detail').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h1 style="color: #fff;">作品不存在</h1>
                            <p style="color: rgba(255, 255, 255, 0.7);">该作品可能已被删除或不存在。</p>
                            <a href="index.html" class="btn btn-primary" style="margin-top: 20px;">返回首页</a>
                        </div>
                    `;
                }
            } catch (error) {
                // 移除加载动画
                loadingOverlay.remove();
                
                console.error('加载作品失败:', error);
                document.querySelector('.work-detail').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h1 style="color: #fff;">加载失败</h1>
                        <p style="color: rgba(255, 255, 255, 0.7);">加载作品数据时出现错误: ${error.message}</p>
                        <a href="index.html" class="btn btn-primary" style="margin-top: 20px;">返回首页</a>
                    </div>
                `;
            }
        });

        // 设置删除功能
        function setupDeleteFunction() {
            const deleteBtn = document.getElementById('deleteBtn');
            
            deleteBtn.addEventListener('click', async function() {
                // 检查是否有token
                if (!GITHUB_CONFIG.token) {
                    showMessage('提示', '请先在上传页面配置GitHub Token才能删除作品');
                    return;
                }
                
                // 确认删除
                if (!confirm(`确定要删除作品 "${currentWork.title}" 吗？此操作不可恢复！`)) {
                    return;
                }
                
                try {
                    // 显示加载动画
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.className = 'loading-overlay';
                    loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
                    document.body.appendChild(loadingOverlay);
                    
                    // 从作品列表中移除当前作品
                    const newWorks = allWorks.filter(w => w.id !== currentWork.id);
                    
                    // 保存到GitHub
                    await saveWorksToGitHub(newWorks);
                    
                    showMessage('成功', '作品已删除，正在返回首页...');
                    
                    // 返回首页
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (error) {
                    console.error('删除作品失败:', error);
                    showMessage('错误', '删除作品失败: ' + error.message);
                } finally {
                    // 移除加载动画
                    const loadingOverlay = document.querySelector('.loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.remove();
                    }
                }
            });
        }

        // 从GitHub加载图片列表
        async function loadGithubImages() {
            try {
                // 构建API请求头
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                if (GITHUB_CONFIG.token) {
                    headers['Authorization'] = `token ${GITHUB_CONFIG.token}`;
                }
                
                // 显示加载提示
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'loading-indicator';
                loadingIndicator.textContent = '正在加载GitHub图片...';
                loadingIndicator.style.textAlign = 'center';
                loadingIndicator.style.color = 'white';
                loadingIndicator.style.padding = '10px';
                loadingIndicator.style.marginBottom = '10px';
                
                const selectContainer = document.querySelector('.github-input');
                if (selectContainer) {
                    selectContainer.prepend(loadingIndicator);
                }
                
                // 先获取仓库中的所有文件
                console.log('开始获取GitHub仓库文件...');
                const response = await fetch(`https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/git/trees/${GITHUB_CONFIG.branch}?recursive=1`, {
                    headers: headers,
                    cache: 'no-store' // 不使用缓存
                });
                
                if (!response.ok) {
                    if (loadingIndicator) loadingIndicator.remove();
                    throw new Error(`获取仓库文件失败: ${response.status} - ${await response.text()}`);
                }
                
                const data = await response.json();
                
                // 筛选图片文件
                const imageFiles = data.tree.filter(file => 
                    file.type === 'blob' && 
                    file.path.match(/\.(png|jpg|jpeg|gif|webp)$/i) &&
                    !file.path.startsWith('node_modules/') // 排除node_modules目录
                );
                
                if (imageFiles.length === 0) {
                    if (loadingIndicator) loadingIndicator.remove();
                    console.log('仓库中没有找到图片文件');
                    return [];
                }
                
                console.log(`找到 ${imageFiles.length} 个图片文件`);
                
                // 移除加载指示器
                if (loadingIndicator) loadingIndicator.remove();
                
                // 返回图片列表，确保URL格式正确
                return imageFiles.map(file => {
                    // 解码文件名（支持中文）
                    const fileName = decodeURIComponent(file.path.split('/').pop());
                    
                    // 创建干净的URL，不添加时间戳
                    const cleanUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${file.path}`;
                    
                    console.log(`处理图片: ${fileName}, URL: ${cleanUrl}`);
                    
                    return {
                        name: fileName,
                        path: file.path,
                        url: cleanUrl
                    };
                });
            } catch (error) {
                console.error('加载GitHub图片失败:', error);
                // 显示错误提示
                const errorMessage = document.createElement('div');
                errorMessage.className = 'github-error';
                errorMessage.textContent = `无法加载GitHub图片: ${error.message}`;
                errorMessage.style.color = '#ff4d4d';
                errorMessage.style.padding = '10px';
                errorMessage.style.marginBottom = '10px';
                errorMessage.style.background = 'rgba(255, 0, 0, 0.1)';
                errorMessage.style.borderRadius = '5px';
                errorMessage.style.textAlign = 'center';
                
                const selectContainer = document.querySelector('.github-input');
                if (selectContainer) {
                    const existingError = selectContainer.querySelector('.github-error');
                    if (existingError) existingError.remove();
                    selectContainer.prepend(errorMessage);
                }
                
                return [];
            }
        }

        // 在setupEditFunction函数中添加GitHub图片选择功能
        function setupEditFunction() {
            const editBtn = document.getElementById('editBtn');
            const editModal = document.getElementById('editModal');
            const editCancel = document.getElementById('editCancel');
            const editSave = document.getElementById('editSave');
            const editTitle = document.getElementById('editTitle');
            const editDescription = document.getElementById('editDescription');
            const editVideoLink = document.getElementById('editVideoLink');
            const editTagInput = document.getElementById('editTagInput');
            const editTagsContainer = document.getElementById('editTagsContainer');
            const editAddTagBtn = document.getElementById('editAddTagBtn');
            const editPreviewContainer = document.getElementById('editPreviewContainer');
            const editPreviewImageArea = document.getElementById('editPreviewImageArea');
            const useGithubCheckbox = document.getElementById('useGithubEdit');
            const githubImageSelectGroup = document.getElementById('githubImageSelectGroup');
            const githubSelect = document.getElementById('githubSelect');
            
            // 编辑按钮点击事件
            editBtn.addEventListener('click', function() {
                // 检查是否有token
                if (!GITHUB_CONFIG.token) {
                    showMessage('提示', '请先在上传页面配置GitHub Token才能编辑作品');
                    return;
                }
                
                // 填充表单并显示编辑模态框
                populateEditForm();
                editModal.classList.add('show');
            });
            
            // 填充编辑表单数据
            function populateEditForm() {
                // 填充基本信息
                editTitle.value = currentWork.title || '';
                editDescription.value = currentWork.description || '';
                editVideoLink.value = currentWork.videoLink || '';
                
                // 清空并填充标签
                editTagsContainer.innerHTML = '';
                editTags = new Set();
                
                if (currentWork.tags && Array.isArray(currentWork.tags)) {
                    currentWork.tags.forEach(tag => {
                        addTagToEditForm(tag);
                    });
                }
                
                // 清空预览图
                editPreviewContainer.innerHTML = '';
                
                // 显示当前预览图（如果有）
                if (currentWork.previewImage) {
                    const previewImg = document.createElement('img');
                    previewImg.src = currentWork.previewImage;
                    previewImg.style.maxWidth = '100%';
                    previewImg.style.borderRadius = '10px';
                    editPreviewContainer.appendChild(previewImg);
                    editPreviewContainer.style.display = 'block';
                } else {
                    editPreviewContainer.style.display = 'none';
                }
            }

            // 标签管理函数
            function addTagToEditForm(tagText) {
                if (!tagText.trim() || editTags.has(tagText)) return;
                
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `
                    ${tagText}
                    <button class="remove-tag">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                editTagsContainer.appendChild(tag);
                editTags.add(tagText);
                
                // 添加删除标签的点击事件
                tag.querySelector('.remove-tag').addEventListener('click', function() {
                    tag.remove();
                    editTags.delete(tagText);
                });
            }

            // 按回车添加标签
            editTagInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTagToEditForm(this.value);
                    this.value = '';
                }
            });

            // 点击添加按钮添加标签
            editAddTagBtn.addEventListener('click', function() {
                addTagToEditForm(editTagInput.value);
                editTagInput.value = '';
            });

            // 修改保存编辑函数，处理GitHub图片
            editSave.addEventListener('click', async function() {
                // 显示加载动画
                const loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.innerHTML = '<div class="loading-spinner"></div>';
                document.body.appendChild(loadingOverlay);
                
                try {
                    // 获取编辑后的数据
                    const updatedWork = {
                        ...currentWork,
                        title: document.getElementById('editTitle').value,
                        description: document.getElementById('editDescription').value,
                        videoLink: document.getElementById('editVideoLink').value,
                        tags: Array.from(editTags),
                        updateTime: new Date().toISOString()
                    };

                    console.log('正在保存编辑后的作品:', updatedWork.title);
                    
                    // 处理图片 - 检查是否使用GitHub图片
                    if (useGithubCheckbox.checked) {
                        const githubSelect = document.getElementById('githubSelect');
                        if (githubSelect && githubSelect.value) {
                            // 使用选择的GitHub图片
                            let selectedUrl = githubSelect.value;
                            console.log('选择的GitHub图片URL原始值:', selectedUrl);
                            
                            // 确保URL是有效的
                            if (selectedUrl && selectedUrl.trim()) {
                                // 去除URL中可能的时间戳参数
                                if (selectedUrl.includes('?')) {
                                    selectedUrl = selectedUrl.split('?')[0];
                                }
                                
                                // 确保使用raw.githubusercontent.com
                                if (selectedUrl.includes('github.com') && !selectedUrl.includes('raw.githubusercontent.com')) {
                                    selectedUrl = selectedUrl
                                        .replace('github.com', 'raw.githubusercontent.com')
                                        .replace('/blob/', '/');
                                }
                                
                                updatedWork.previewImage = selectedUrl;
                                console.log('处理后的GitHub图片URL:', updatedWork.previewImage);
                                
                                // 预检图片是否可加载
                                try {
                                    await new Promise((resolve, reject) => {
                                        const testImg = new Image();
                                        testImg.crossOrigin = 'anonymous';
                                        testImg.onload = resolve;
                                        testImg.onerror = () => reject(new Error('图片加载测试失败'));
                                        // 添加随机参数避免缓存影响测试
                                        testImg.src = `${selectedUrl}?test=${Date.now()}`;
                                    });
                                    console.log('图片加载测试成功');
                                    await saveUpdatedWork(updatedWork);
                                } catch (imgError) {
                                    console.error('图片加载测试失败:', imgError);
                                    throw new Error('GitHub图片无法加载，请选择其他图片或检查URL格式');
                                }
                            } else {
                                throw new Error('请选择有效的GitHub图片');
                            }
                        } else {
                            throw new Error('请选择GitHub图片');
                        }
                    } else {
                        // 处理上传的预览图
                        const previewImage = document.getElementById('editPreviewImage').files[0];
                        if (previewImage) {
                            // 转换为base64
                            const reader = new FileReader();
                            reader.onload = async function(e) {
                                console.log('保存本地上传的图片，大小:', Math.round(e.target.result.length / 1024), 'KB');
                                updatedWork.previewImage = e.target.result;
                                await saveUpdatedWork(updatedWork);
                            };
                            reader.onerror = function(e) {
                                loadingOverlay.remove();
                                showMessage('错误', '读取图片失败: ' + e.target.error);
                            };
                            reader.readAsDataURL(previewImage);
                        } else if (currentWork.previewImage) {
                            // 没有上传新图片，保持原图
                            console.log('没有选择新图片，保持原始图片');
                            // 清理原始URL中的时间戳参数
                            if (currentWork.previewImage.includes('?')) {
                                updatedWork.previewImage = currentWork.previewImage.split('?')[0];
                                console.log('清理后的原始图片URL:', updatedWork.previewImage);
                            } else {
                                updatedWork.previewImage = currentWork.previewImage;
                            }
                            await saveUpdatedWork(updatedWork);
                        } else {
                            // 没有图片也可以保存
                            await saveUpdatedWork(updatedWork);
                        }
                    }
                } catch (error) {
                    console.error('保存编辑失败:', error);
                    loadingOverlay.remove();
                    showMessage('错误', '保存失败: ' + error.message);
                }
            });

            // 修改保存更新后的作品到GitHub函数
            async function saveUpdatedWork(updatedWork) {
                try {
                    // 更新作品列表中的对应作品
                    const index = allWorks.findIndex(w => w.id === updatedWork.id);
                    if (index !== -1) {
                        // 确保GitHub图片URL是完整且有效的URL
                        if (updatedWork.previewImage) {
                            // 对于GitHub图片URL需确保是完整路径
                            if (updatedWork.previewImage.includes('githubusercontent.com')) {
                                // 已经是完整的GitHub URL，检查URL格式是否正确
                                console.log('使用现有GitHub图片URL:', updatedWork.previewImage);
                                
                                // 确保使用raw.githubusercontent.com而不是github.com
                                if (updatedWork.previewImage.includes('github.com') && !updatedWork.previewImage.includes('raw.githubusercontent.com')) {
                                    // 转换为raw URL
                                    updatedWork.previewImage = updatedWork.previewImage
                                        .replace('github.com', 'raw.githubusercontent.com')
                                        .replace('/blob/', '/');
                                    console.log('转换为raw GitHub URL:', updatedWork.previewImage);
                                }
                                
                                // 确保URL不包含引号或多余的空格
                                updatedWork.previewImage = updatedWork.previewImage.trim().replace(/["']/g, '');
                                
                                // 移除可能存在的时间戳参数，以避免重复添加
                                if (updatedWork.previewImage.includes('?')) {
                                    updatedWork.previewImage = updatedWork.previewImage.split('?')[0];
                                }
                            } else if (!updatedWork.previewImage.startsWith('data:')) {
                                // 如果不是data:URL也不是完整的GitHub URL，尝试构建完整URL
                                if (!updatedWork.previewImage.startsWith('http')) {
                                    // 清理路径中可能存在的前导斜杠
                                    const cleanPath = updatedWork.previewImage.replace(/^\/+/, '');
                                    updatedWork.previewImage = `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${cleanPath}`;
                                    console.log('构建完整的GitHub图片URL:', updatedWork.previewImage);
                                }
                            }
                        } else {
                            // 如果没有预览图，设置一个默认图片
                            updatedWork.previewImage = 'https://via.placeholder.com/800x450?text=无图片';
                            console.warn('没有提供预览图，使用默认图片');
                        }
                        
                        allWorks[index] = updatedWork;
                        
                        // 保存到GitHub
                        await saveWorksToGitHub(allWorks);
                        
                        // 关闭模态框
                        editModal.classList.remove('show');
                        
                        // 刷新页面显示更新后的内容
                        showMessage('成功', '作品已更新，正在刷新页面...');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        throw new Error('找不到作品');
                    }
                } catch (error) {
                    throw error;
                } finally {
                    // 移除加载动画
                    const loadingOverlay = document.querySelector('.loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.remove();
                    }
                }
            }

            // 点击模态框外部关闭
            editModal.addEventListener('click', function(e) {
                if (e.target === editModal) {
                    editModal.classList.remove('show');
                }
            });
            
            // 添加文件上传区域的交互
            const fileDropArea = document.querySelector('.file-drop-area');
            const fileInput = document.getElementById('editPreviewImage');

            if (fileDropArea && fileInput) {
                // 点击上传区域激活文件选择
                fileDropArea.addEventListener('click', function() {
                    fileInput.click();
                });

                // 文件选择后显示预览
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            // 创建或更新预览图
                            let previewImg = editPreviewContainer.querySelector('img');
                            if (!previewImg) {
                                previewImg = document.createElement('img');
                                previewImg.style.maxWidth = '100%';
                                previewImg.style.borderRadius = '10px';
                                editPreviewContainer.appendChild(previewImg);
                            }
                            previewImg.src = e.target.result;
                            editPreviewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(this.files[0]);
                    }
                });

                // 拖放文件功能
                fileDropArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('active');
                });

                fileDropArea.addEventListener('dragleave', function() {
                    this.classList.remove('active');
                });

                fileDropArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('active');
                    
                    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                        fileInput.files = e.dataTransfer.files;
                        const changeEvent = new Event('change');
                        fileInput.dispatchEvent(changeEvent);
                    }
                });
            }

            // 设置使用GitHub图片选择器的事件
            useGithubCheckbox.addEventListener('change', async function() {
                console.log('GitHub图片选择状态改变:', this.checked);
                if (this.checked) {
                    // 显示GitHub图片选择区域，隐藏上传区域
                    githubImageSelectGroup.style.display = 'block';
                    editPreviewImageArea.style.display = 'none';
                    
                    try {
                        // 添加加载提示
                        const loadingIndicator = document.createElement('div');
                        loadingIndicator.className = 'loading-spinner';
                        loadingIndicator.style.margin = '20px auto';
                        githubImageSelectGroup.querySelector('.github-input').innerHTML = '';
                        githubImageSelectGroup.querySelector('.github-input').appendChild(loadingIndicator);
                        
                        // 加载GitHub图片
                        const images = await loadGithubImages();
                        
                        if (images.length === 0) {
                            githubImageSelectGroup.querySelector('.github-input').innerHTML = `
                                <div style="padding: 20px; color: #ff4d4d; text-align: center;">
                                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                                    <p>未找到图片</p>
                                    <p style="font-size: 0.8em; opacity: 0.8; margin-top: 5px;">请先上传图片到GitHub仓库</p>
                                </div>
                            `;
                            return;
                        }
                        
                        // 重建下拉列表UI
                        githubImageSelectGroup.querySelector('.github-input').innerHTML = `
                            <select class="github-select" id="githubSelect">
                                <option value="">选择GitHub图片</option>
                            </select>
                            <div id="githubPreviewEdit" class="github-preview" style="display:none; margin-top: 15px;"></div>
                        `;
                        
                        // 获取新创建的select元素
                        const githubSelect = document.getElementById('githubSelect');
                        
                        // 根据文件类型对图片进行分组
                        const imagesByType = {};
                        images.forEach(image => {
                            const ext = image.name.split('.').pop().toLowerCase();
                            if (!imagesByType[ext]) {
                                imagesByType[ext] = [];
                            }
                            imagesByType[ext].push(image);
                        });
                        
                        // 创建分组选项
                        Object.keys(imagesByType).sort().forEach(ext => {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = ext.toUpperCase() + ' 图片';
                            
                            // 将图片按名称排序
                            imagesByType[ext].sort((a, b) => a.name.localeCompare(b.name)).forEach(image => {
                                const option = document.createElement('option');
                                option.value = image.url;
                                option.textContent = image.name;
                                option.title = image.path; // 添加完整路径的提示
                                optgroup.appendChild(option);
                            });
                            
                            githubSelect.appendChild(optgroup);
                        });
                        
                        console.log(`GitHub图片选择器已更新，共有 ${images.length} 张图片`);
                        
                        // 添加选择事件监听
                        githubSelect.addEventListener('change', function() {
                            const selectedUrl = this.value;
                            const githubPreview = document.getElementById('githubPreviewEdit');
                            
                            if (selectedUrl) {
                                console.log('选择的GitHub图片:', selectedUrl);
                                githubPreview.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';
                                githubPreview.style.display = 'block';
                                
                                const img = document.createElement('img');
                                img.alt = "GitHub图片预览";
                                img.style.maxWidth = "100%";
                                img.crossOrigin = "anonymous";
                                
                                img.onload = function() {
                                    githubPreview.innerHTML = '';
                                    githubPreview.appendChild(img);
                                };
                                
                                img.onerror = function() {
                                    githubPreview.innerHTML = `
                                        <div style="padding: 20px; color: #ff4d4d; text-align: center;">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <p>图片加载失败</p>
                                            <button id="reloadPreviewBtn" style="margin-top: 10px; background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">重试</button>
                                        </div>
                                    `;
                                    
                                    document.getElementById('reloadPreviewBtn')?.addEventListener('click', function() {
                                        const newImg = new Image();
                                        newImg.src = `${selectedUrl}?t=${Date.now()}`;
                                        newImg.style.maxWidth = "100%";
                                        githubPreview.innerHTML = '<div class="loading-spinner" style="margin: 20px auto;"></div>';
                                        
                                        newImg.onload = function() {
                                            githubPreview.innerHTML = '';
                                            githubPreview.appendChild(newImg);
                                        };
                                        
                                        newImg.onerror = function() {
                                            githubPreview.innerHTML = '<div style="color: #ff4d4d; text-align: center;">重试失败，请选择其他图片</div>';
                                        };
                                    });
                                };
                                
                                // 添加时间戳参数避免缓存
                                img.src = `${selectedUrl}?t=${Date.now()}`;
                            } else {
                                githubPreview.style.display = 'none';
                                githubPreview.innerHTML = '';
                            }
                        });
                        
                        // 如果当前作品使用的是GitHub图片，尝试自动选中
                        if (currentWork.previewImage && currentWork.previewImage.includes('githubusercontent.com')) {
                            const cleanUrl = currentWork.previewImage.split('?')[0];
                            
                            // 遍历选项，查找匹配的URL
                            const options = Array.from(githubSelect.querySelectorAll('option'));
                            const matchingOption = options.find(option => {
                                if (!option.value) return false;
                                return option.value.split('?')[0] === cleanUrl;
                            });
                            
                            if (matchingOption) {
                                matchingOption.selected = true;
                                const event = new Event('change');
                                githubSelect.dispatchEvent(event);
                                console.log('自动选中当前图片:', matchingOption.value);
                            }
                        }
                    } catch (error) {
                        console.error('加载GitHub图片失败:', error);
                        githubImageSelectGroup.querySelector('.github-input').innerHTML = `
                            <div style="padding: 20px; color: #ff4d4d; text-align: center; background: rgba(255, 0, 0, 0.1); border-radius: 5px;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                                <p>加载GitHub图片失败: ${error.message}</p>
                            </div>
                        `;
                    }
                } else {
                    // 显示上传区域，隐藏GitHub图片选择区域
                    githubImageSelectGroup.style.display = 'none';
                    editPreviewImageArea.style.display = 'block';
                }
            });

            // 取消按钮事件
            editCancel.addEventListener('click', function() {
                editModal.classList.remove('show');
            });
        }

        // 设置图片查看器
        function setupImageViewer() {
            const workPreviewContainer = document.getElementById('workPreviewContainer');
            const imageViewModal = document.getElementById('imageViewModal');
            const largeImage = document.getElementById('largeImage');
            const closeImageView = document.getElementById('closeImageView');

            // 点击预览图查看大图
            workPreviewContainer.addEventListener('click', function() {
                largeImage.src = currentWork.previewImage;
                imageViewModal.classList.add('show');
            });

            // 关闭大图查看
            closeImageView.addEventListener('click', function() {
                imageViewModal.classList.remove('show');
            });

            // 点击模态框外部关闭
            imageViewModal.addEventListener('click', function(e) {
                if (e.target === imageViewModal) {
                    imageViewModal.classList.remove('show');
                }
            });

            // 按ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && imageViewModal.classList.contains('show')) {
                    imageViewModal.classList.remove('show');
                }
            });
        }
    </script>
</body>
</html> 